image: node:20

stages:
  - test

variables:
  PNPM_HOME: "$CI_PROJECT_DIR/.pnpm"
  PATH: "$PNPM_HOME:$PATH"

  # Prisma needs these env vars to exist for `prisma generate` during install.
  # They do NOT need to be real DBs for unit/integration tests with mocks.
  DATABASE_URL: "postgresql://user:pass@localhost:5432/postgres?schema=public"
  DIRECT_URL: "postgresql://user:pass@localhost:5432/postgres?schema=public"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - driving_school_platform/nextjs_space/.pnpm-store
    - driving_school_platform/nextjs_space/node_modules

before_script:
  - corepack enable
  - cd driving_school_platform/nextjs_space
  - pnpm config set store-dir .pnpm-store
  - pnpm install --frozen-lockfile

test:
  stage: test
  script:
    - pnpm run test:run
    - pnpm run build
