image: node:20

stages:
  - test

variables:
  # Prisma needs these env vars to exist for `prisma generate` during install.
  # They do NOT need to be real DBs for unit/integration tests with mocks.
  DATABASE_URL: "postgresql://user:pass@localhost:5432/postgres?schema=public"
  DIRECT_URL: "postgresql://user:pass@localhost:5432/postgres?schema=public"

cache:
  key:
    files:
      - driving_school_platform/nextjs_space/pnpm-lock.yaml
  paths:
    - driving_school_platform/nextjs_space/.pnpm-store
    - driving_school_platform/nextjs_space/.next/cache

before_script:
  - corepack enable
  - corepack prepare pnpm@10.24.0 --activate
  - cd driving_school_platform/nextjs_space
  - pnpm -v
  - export PNPM_HOME="$CI_PROJECT_DIR/.pnpm"
  - export PATH="$PNPM_HOME:$PATH"
  - pnpm config set store-dir .pnpm-store
  - pnpm install --frozen-lockfile

test:
  stage: test
  script:
    - pnpm run test:run
    - pnpm run build
