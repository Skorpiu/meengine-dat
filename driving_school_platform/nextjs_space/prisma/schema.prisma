// Driving School Management Platform - Prisma Schema
generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Authentication and User Management
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Core User Table
model User {
  id                          String    @id @default(cuid())
  email                       String    @unique
  emailVerified              DateTime?
  image                      String?
  passwordHash               String?
  role                       UserRole  @default(STUDENT)
  firstName                  String
  lastName                   String
  phoneNumber                String?
  dateOfBirth                DateTime?
  address                    String?
  city                       String?
  postalCode                 String?
  profilePictureUrl          String?
  
  // Organization Link (License Management)
  organizationId             String?
  
  // Account status
  isEmailVerified           Boolean   @default(false)
  emailVerificationToken    String?
  emailVerificationExpiresAt DateTime?
  isApproved                Boolean   @default(false)
  
  // Password reset
  passwordResetToken        String?
  passwordResetExpiresAt    DateTime?
  
  // Metadata
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  lastLoginAt              DateTime?

  // Relations
  organization              Organization? @relation(fields: [organizationId], references: [id])
  accounts                  Account[]
  sessions                  Session[]
  student                   Student?
  instructor               Instructor?
  preferences              UserPreference?
  lessonRequestsReviewed   LessonRequest[] @relation("ReviewedBy")
  lessonsCancelled         Lesson[] @relation("CancelledBy")
  paymentsUser             Payment[] @relation("PaymentUser")
  notifications            Notification[]
  auditLogs                AuditLog[]

  // Indexes
  @@index([email])
  @@index([role])
  @@index([isApproved])
  @@index([createdAt])
  @@index([organizationId])
  @@map("users")
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  SUPER_ADMIN
}

// Transmission Types
model TransmissionType {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  code        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  categories  Category[]
  students    Student[]
  instructors Instructor[] @relation("InstructorTransmissionTypes")
  vehicles    Vehicle[]
  lessons     Lesson[]

  @@map("transmission_types")
}

// Categories (License types)
model Category {
  id                     Int              @id @default(autoincrement())
  name                   String           @unique
  fullName               String
  description            String?
  transmissionTypeId     Int?
  minAge                 Int?
  requiresTheoryExam     Boolean          @default(true)
  requiresPracticalExam  Boolean          @default(true)
  minLessonHours         Int              @default(0)
  isActive               Boolean          @default(true)
  displayOrder           Int              @default(0)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt

  // Relations
  transmissionType       TransmissionType? @relation(fields: [transmissionTypeId], references: [id])
  students               Student[]
  instructors            Instructor[] @relation("InstructorCategories")
  vehicles               Vehicle[]
  lessons                Lesson[]
  exams                  Exam[]
  lessonCounters         LessonCounter[]
  lessonRequests         LessonRequest[]

  @@map("categories")
}

// Students
model Student {
  id                             String          @id @default(cuid())
  userId                         String          @unique
  studentIdNumber                String?         @unique
  categoryId                     Int?
  transmissionTypeId             Int?
  organizationId                 String?
  
  // License information
  hasDrivingLicense              Boolean         @default(false)
  existingLicenseNumber          String?
  existingLicenseCategories      String[]
  
  // Medical
  medicalCertificateUrl          String?
  medicalCertificateExpiry       DateTime?
  
  // Emergency contact
  emergencyContactName           String?
  emergencyContactPhone          String?
  emergencyContactRelationship   String?
  
  // Preferences
  preferredInstructorId          String?
  preferredLessonTime            String?
  
  // Progress tracking
  theoryExamPassed               Boolean         @default(false)
  practicalExamPassed            Boolean         @default(false)
  enrollmentDate                 DateTime        @default(now())
  graduationDate                 DateTime?
  
  // Notes
  adminNotes                     String?
  specialRequirements            String?
  
  createdAt                      DateTime        @default(now())
  updatedAt                      DateTime        @updatedAt

  // Relations
  user                           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category                       Category?       @relation(fields: [categoryId], references: [id])
  transmissionType               TransmissionType? @relation(fields: [transmissionTypeId], references: [id])
  organization                   Organization?   @relation(fields: [organizationId], references: [id])
  preferredInstructor            Instructor?     @relation("PreferredStudents", fields: [preferredInstructorId], references: [id])
  lessons                        Lesson[]
  lessonRequests                 LessonRequest[]
  lessonCounters                 LessonCounter[]
  examRegistrations              ExamRegistration[]
  paymentsStudent                Payment[]       @relation("PaymentStudent")

  // Indexes
  @@index([userId])
  @@index([categoryId])
  @@index([transmissionTypeId])
  @@index([organizationId])
  @@map("students")
}

// Instructors
model Instructor {
  id                            String          @id @default(cuid())
  userId                        String          @unique
  instructorIdNumber            String?         @unique
  organizationId                String?
  
  // Certifications
  instructorLicenseNumber       String          @unique
  instructorLicenseExpiry       DateTime
  instructorCertificateUrl      String?
  
  // Work information
  hireDate                      DateTime?
  employmentType                EmploymentType?
  hourlyRate                    Decimal?
  
  // Availability
  defaultWorkingHours           Json?
  maxLessonsPerDay              Int             @default(8)
  
  // Performance metrics
  totalLessonsCompleted         Int             @default(0)
  averageRating                 Decimal         @default(0.00)
  totalStudentsTrained          Int             @default(0)
  passRatePercentage            Decimal         @default(0.00)
  
  // Status
  isAvailableForBooking         Boolean         @default(true)
  
  // Notes
  adminNotes                    String?
  specializations               String?
  
  createdAt                     DateTime        @default(now())
  updatedAt                     DateTime        @updatedAt

  // Relations
  user                          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization                  Organization?   @relation(fields: [organizationId], references: [id])
  qualifiedCategories           Category[]      @relation("InstructorCategories")
  qualifiedTransmissionTypes    TransmissionType[] @relation("InstructorTransmissionTypes")
  preferredStudents             Student[]       @relation("PreferredStudents")
  lessons                       Lesson[]
  lessonRequests                LessonRequest[]
  exams                         Exam[]

  // Indexes
  @@index([userId])
  @@index([isAvailableForBooking])
  @@index([organizationId])
  @@map("instructors")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
}

// Vehicles
model Vehicle {
  id                    Int              @id @default(autoincrement())
  registrationNumber    String           @unique
  
  // Vehicle details
  make                  String
  model                 String
  year                  Int
  color                 String?
  vin                   String?          @unique
  
  // Classification
  categoryId            Int?
  transmissionTypeId    Int
  
  // Status
  status                VehicleStatus    @default(AVAILABLE)
  isActive              Boolean          @default(true)
  underMaintenance      Boolean          @default(false)
  
  // Maintenance
  lastServiceDate       DateTime?
  nextServiceDate       DateTime?
  lastServiceMileage    Int?
  currentMileage        Int              @default(0)
  serviceIntervalKm     Int              @default(10000)
  
  // Insurance
  insurancePolicyNumber String?
  insuranceExpiryDate   DateTime?
  insuranceCompany      String?
  
  // Features
  hasDualControls       Boolean          @default(true)
  hasDashcam            Boolean          @default(false)
  fuelType              FuelType?
  
  // Media
  vehicleImageUrl       String?
  
  // Notes
  adminNotes            String?
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  // Relations
  category              Category?        @relation(fields: [categoryId], references: [id])
  transmissionType      TransmissionType @relation(fields: [transmissionTypeId], references: [id])
  lessons               Lesson[]
  exams                 Exam[]
  lessonRequests        LessonRequest[]

  // Indexes
  @@index([status])
  @@index([categoryId])
  @@index([transmissionTypeId])
  @@index([isActive])
  @@index([nextServiceDate])
  @@map("vehicles")
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_SERVICE
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
}

// Lesson Requests
model LessonRequest {
  id                    String          @id @default(cuid())
  studentId             String
  instructorId          String?
  
  // Request details
  requestedDate         DateTime
  requestedStartTime    String          // HH:MM format
  requestedEndTime      String          // HH:MM format
  lessonType            LessonType
  categoryId            Int
  
  // Optional vehicle preference
  preferredVehicleId    Int?
  
  // Status workflow
  status                RequestStatus   @default(PENDING)
  
  // Approval tracking
  reviewedBy            String?
  reviewedAt            DateTime?
  rejectionReason       String?
  
  // Notes
  studentNotes          String?
  adminNotes            String?
  
  // Reference to created lesson
  lessonId              String?
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  student               Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor            Instructor?     @relation(fields: [instructorId], references: [id])
  category              Category        @relation(fields: [categoryId], references: [id])
  preferredVehicle      Vehicle?        @relation(fields: [preferredVehicleId], references: [id])
  reviewer              User?           @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  lesson                Lesson?         @relation(fields: [lessonId], references: [id])

  // Indexes
  @@index([studentId])
  @@index([instructorId])
  @@index([status])
  @@index([requestedDate])
  @@map("lesson_requests")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Lessons
model Lesson {
  id                        String          @id @default(cuid())
  
  // Participants
  studentId                 String?
  instructorId              String
  vehicleId                 Int?
  
  // Schedule
  lessonDate                DateTime
  startTime                 String          // HH:MM format
  endTime                   String          // HH:MM format
  durationMinutes           Int
  
  // Classification
  lessonType                LessonType
  categoryId                Int
  transmissionTypeId        Int?
  
  // Status
  status                    LessonStatus    @default(SCHEDULED)
  
  // Completion details
  startedAt                 DateTime?
  completedAt               DateTime?
  startMileage              Int?
  endMileage                Int?
  
  // Location
  pickupLocation            String?
  dropoffLocation           String?
  routeDescription          String?
  
  // Evaluation
  instructorRating          Int?
  instructorFeedback        String?
  skillsPracticed           String[]
  areasForImprovement       String?
  studentPerformanceRating  Int?
  
  // Student feedback
  studentRating             Int?
  studentFeedback           String?
  
  // Cancellation
  cancelledBy               String?
  cancelledAt               DateTime?
  cancellationReason        String?
  
  // Pricing
  lessonPrice               Decimal?
  paymentStatus             PaymentStatus   @default(PENDING)
  
  // Notes
  adminNotes                String?
  
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  // Relations
  student                   Student?        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  instructor                Instructor      @relation(fields: [instructorId], references: [id])
  vehicle                   Vehicle?        @relation(fields: [vehicleId], references: [id])
  category                  Category        @relation(fields: [categoryId], references: [id])
  transmissionType          TransmissionType? @relation(fields: [transmissionTypeId], references: [id])
  cancelledByUser           User?           @relation("CancelledBy", fields: [cancelledBy], references: [id])
  lessonRequests            LessonRequest[]
  payments                  Payment[]

  // Indexes
  @@index([studentId])
  @@index([instructorId])
  @@index([vehicleId])
  @@index([lessonDate])
  @@index([status])
  @@index([lessonType])
  @@index([lessonDate, status])
  @@index([instructorId, lessonDate])
  @@index([studentId, lessonDate])
  @@index([lessonType, lessonDate, status])
  @@map("lessons")
}

enum LessonType {
  DRIVING
  THEORY
  EXAM
}

enum LessonStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  WAIVED
}

// Lesson Counters
model LessonCounter {
  id                      String    @id @default(cuid())
  studentId               String
  categoryId              Int
  
  // Counters by lesson type
  totalDrivingLessons     Int       @default(0)
  completedDrivingLessons Int       @default(0)
  totalTheoryLessons      Int       @default(0)
  completedTheoryLessons  Int       @default(0)
  
  // Hours tracking
  totalDrivingHours       Decimal   @default(0.00)
  requiredDrivingHours    Decimal   @default(0.00)
  
  // Exam attempts
  theoryExamAttempts      Int       @default(0)
  practicalExamAttempts   Int       @default(0)
  
  // Progress percentage
  progressPercentage      Decimal   @default(0.00)
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  student                 Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  category                Category  @relation(fields: [categoryId], references: [id])

  @@unique([studentId, categoryId])
  @@map("lesson_counters")
}

// Exams
model Exam {
  id                    String              @id @default(cuid())
  
  // Exam details
  examType              ExamType
  categoryId            Int
  
  // Schedule
  examDate              DateTime
  startTime             String              // HH:MM format
  endTime               String              // HH:MM format
  
  // Location
  examLocation          String
  examCenterName        String?
  
  // For practical exams
  vehicleId             Int?
  examinerId            String?
  
  // Capacity
  maxStudents           Int                 @default(1)
  currentStudentsCount  Int                 @default(0)
  
  // Status
  status                ExamStatus          @default(SCHEDULED)
  
  // Notes
  specialInstructions   String?
  adminNotes            String?
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  category              Category            @relation(fields: [categoryId], references: [id])
  vehicle               Vehicle?            @relation(fields: [vehicleId], references: [id])
  examiner              Instructor?         @relation(fields: [examinerId], references: [id])
  registrations         ExamRegistration[]

  // Indexes
  @@index([examDate])
  @@index([status])
  @@index([categoryId])
  @@index([examinerId])
  @@map("exams")
}

enum ExamType {
  THEORY
  PRACTICAL
}

enum ExamStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Exam Registrations
model ExamRegistration {
  id                    String              @id @default(cuid())
  examId                String
  studentId             String
  
  // Registration
  registrationDate      DateTime            @default(now())
  registrationFee       Decimal?
  paymentStatus         PaymentStatus       @default(PENDING)
  
  // Status
  attendanceStatus      AttendanceStatus    @default(REGISTERED)
  
  // Results
  result                ExamResult?
  score                 Decimal?
  examinerComments      String?
  resultDate            DateTime?
  
  // Attempt number
  attemptNumber         Int                 @default(1)
  
  // Certificate
  certificateIssued     Boolean             @default(false)
  certificateNumber     String?
  certificateIssueDate  DateTime?
  certificateUrl        String?
  
  updatedAt             DateTime            @updatedAt

  // Relations
  exam                  Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  student               Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments              Payment[]

  // Indexes
  @@index([examId])
  @@index([studentId])
  @@index([result])
  @@unique([examId, studentId])
  @@map("exam_registrations")
}

enum AttendanceStatus {
  REGISTERED
  PRESENT
  ABSENT
  CANCELLED
}

enum ExamResult {
  PASS
  FAIL
  PENDING
}

// Payments
model Payment {
  id                    String              @id @default(cuid())
  
  // Payer
  userId                String
  studentId             String?
  
  // Payment details
  amount                Decimal
  currency              String              @default("USD")
  paymentMethod         PaymentMethod?
  
  // Payment type
  paymentType           PaymentType
  
  // References
  lessonId              String?
  examRegistrationId    String?
  
  // Status
  status                PaymentStatus       @default(PENDING)
  
  // Transaction details
  transactionId         String?             @unique
  transactionDate       DateTime            @default(now())
  
  // Gateway information
  paymentGateway        String?
  gatewayResponse       Json?
  
  // Refund information
  refundAmount          Decimal?
  refundDate            DateTime?
  refundReason          String?
  
  // Receipt
  receiptNumber         String?             @unique
  receiptUrl            String?
  
  // Notes
  description           String?
  adminNotes            String?
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user                  User                @relation("PaymentUser", fields: [userId], references: [id], onDelete: Cascade)
  student               Student?            @relation("PaymentStudent", fields: [studentId], references: [id])
  lesson                Lesson?             @relation(fields: [lessonId], references: [id])
  examRegistration      ExamRegistration?   @relation(fields: [examRegistrationId], references: [id])

  // Indexes
  @@index([userId])
  @@index([studentId])
  @@index([status])
  @@index([transactionDate])
  @@index([lessonId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  ONLINE
  MOBILE_PAYMENT
}

enum PaymentType {
  LESSON_FEE
  EXAM_FEE
  REGISTRATION_FEE
  MATERIAL_FEE
  LATE_FEE
  OTHER
}

// Notifications
model Notification {
  id                String              @id @default(cuid())
  userId            String
  
  // Notification details
  type              NotificationType
  title             String
  message           String
  
  // Related entities
  lessonId          String?
  examId            String?
  lessonRequestId   String?
  
  // Status
  isRead            Boolean             @default(false)
  readAt            DateTime?
  
  // Delivery
  sendEmail         Boolean             @default(false)
  emailSent         Boolean             @default(false)
  emailSentAt       DateTime?
  
  sendPush          Boolean             @default(false)
  pushSent          Boolean             @default(false)
  pushSentAt        DateTime?
  
  // Priority
  priority          NotificationPriority @default(NORMAL)
  
  // Action link
  actionUrl         String?
  
  createdAt         DateTime            @default(now())
  expiresAt         DateTime?

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  LESSON_SCHEDULED
  LESSON_CANCELLED
  LESSON_REMINDER
  EXAM_SCHEDULED
  EXAM_RESULT
  PAYMENT_RECEIVED
  APPROVAL_REQUIRED
  APPROVAL_GRANTED
  APPROVAL_REJECTED
  SYSTEM_ANNOUNCEMENT
  INSTRUCTOR_ASSIGNED
  OTHER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Audit Logs
model AuditLog {
  id            String      @id @default(cuid())
  
  // Actor
  userId        String?
  userEmail     String?
  userRole      UserRole?
  
  // Action details
  action        String
  entityType    String
  entityId      String?
  
  // Changes
  oldValues     Json?
  newValues     Json?
  
  // Request context
  ipAddress     String?
  userAgent     String?
  requestMethod String?
  requestPath   String?
  
  // Status
  status        AuditStatus
  errorMessage  String?
  
  createdAt     DateTime    @default(now())

  // Relations
  user          User?       @relation(fields: [userId], references: [id])

  // Indexes
  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

enum AuditStatus {
  SUCCESS
  FAILURE
  ERROR
}

// Organizations (Driving Schools with License Management)
model Organization {
  id                  String    @id @default(cuid())
  name                String    @unique
  email               String?
  phoneNumber         String?
  address             String?
  city                String?
  postalCode          String?
  
  // Branding
  logo                String?
  primaryColor        String?   @default("#2563eb")
  secondaryColor      String?   @default("#dc2626")
  
  // License Management
  subscriptionTier    SubscriptionTier @default(BASE)
  subscriptionStatus  SubscriptionStatus @default(ACTIVE)
  trialEndsAt         DateTime?
  subscriptionEndsAt  DateTime?
  
  // Contact & Billing
  contactName         String?
  billingEmail        String?
  
  // Status
  isActive            Boolean   @default(true)
  
  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  users               User[]
  students            Student[]
  instructors         Instructor[]
  features            OrganizationFeature[]
  licenseKeys         LicenseKey[]

  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([isActive])
  @@map("organizations")
}

enum SubscriptionTier {
  BASE        // Basic features only
  PREMIUM     // All features
  ENTERPRISE  // Custom features (future)
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  EXPIRED
  SUSPENDED
  CANCELLED
}

// Organization Features (License Management)
model OrganizationFeature {
  id              String   @id @default(cuid())
  organizationId  String
  featureKey      String   // e.g., "STUDENT_ACCESS", "SCREENSHOT_PROTECTION"
  
  // Status
  isEnabled       Boolean  @default(false)
  
  // Audit
  enabledAt       DateTime?
  disabledAt      DateTime?
  enabledBy       String?  // User ID who enabled
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@index([featureKey])
  @@index([isEnabled])
  @@map("organization_features")
}

// License Keys (for manual activation)
model LicenseKey {
  id              String   @id @default(cuid())
  organizationId  String
  
  // License Key
  key             String   @unique
  featureKeys     String[] // Features this key unlocks
  
  // Status
  isActive        Boolean  @default(true)
  isUsed          Boolean  @default(false)
  usedAt          DateTime?
  
  // Expiration
  expiresAt       DateTime?
  
  // Metadata
  notes           String?
  createdBy       String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([key])
  @@index([isActive])
  @@map("license_keys")
}

// System Settings
model SystemSetting {
  id           String      @id @default(cuid())
  settingKey   String      @unique
  settingValue String
  settingType  SettingType @default(STRING)
  description  String?
  category     String?
  isPublic     Boolean     @default(false)
  updatedBy    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([category])
  @@index([isPublic])
  @@map("system_settings")
}

enum SettingType {
  STRING
  INTEGER
  BOOLEAN
  JSON
  DECIMAL
}

// Feature Flags - for A/B testing and feature toggles
model FeatureFlag {
  id              String   @id @default(cuid())
  flagKey         String   @unique
  flagName        String
  description     String?
  isEnabled       Boolean  @default(false)
  
  // Targeting
  enabledForRoles String[] // Empty array means all roles
  enabledForUsers String[] // Specific user IDs
  
  // Rollout percentage (0-100)
  rolloutPercent  Int      @default(0)
  
  // Environment
  environment     String   @default("production") // production, staging, development
  
  // Metadata
  category        String?
  tags            String[]
  
  // Audit
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Optional end date for time-limited features
  expiresAt       DateTime?

  @@index([flagKey])
  @@index([isEnabled])
  @@index([environment])
  @@map("feature_flags")
}

// User Preferences - individual user customizations
model UserPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  
  // Interface preferences
  theme             String   @default("light") // light, dark, auto
  language          String   @default("en") // en, pt
  
  // Notification preferences
  emailNotifications            Boolean @default(true)
  pushNotifications             Boolean @default(true)
  smsNotifications              Boolean @default(false)
  
  // Specific notification types
  lessonReminders               Boolean @default(true)
  examReminders                 Boolean @default(true)
  paymentReminders              Boolean @default(true)
  promotionalEmails             Boolean @default(false)
  weeklyDigest                  Boolean @default(true)
  
  // Dashboard preferences
  defaultDashboardView          String  @default("overview") // overview, calendar, list
  showCompletedLessons          Boolean @default(true)
  lessonDisplayCount            Int     @default(5)
  
  // Calendar preferences
  calendarView                  String  @default("month") // day, week, month
  startOfWeek                   String  @default("monday") // monday, sunday
  timeFormat                    String  @default("24h") // 12h, 24h
  
  // Privacy
  profileVisibility             String  @default("school") // public, school, private
  showProgressToInstructors     Boolean @default(true)
  allowContactFromInstructors   Boolean @default(true)
  
  // Accessibility
  fontSize                      String  @default("medium") // small, medium, large
  highContrast                  Boolean @default(false)
  reducedMotion                 Boolean @default(false)
  
  // Custom settings (JSON for extensibility)
  customSettings                Json?
  
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  // Relations
  user                          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// Configuration History - track changes to settings and feature flags
model ConfigurationHistory {
  id            String   @id @default(cuid())
  
  // What was changed
  entityType    String   // SystemSetting, FeatureFlag, UserPreference
  entityId      String
  entityKey     String?  // settingKey, flagKey, userId
  
  // Change details
  action        String   // CREATED, UPDATED, DELETED, ENABLED, DISABLED
  oldValue      Json?
  newValue      Json?
  
  // Who changed it
  changedBy     String?
  changedByRole String?
  
  // When
  changedAt     DateTime @default(now())
  
  // Context
  changeReason  String?
  ipAddress     String?

  @@index([entityType])
  @@index([entityId])
  @@index([changedAt])
  @@index([changedBy])
  @@map("configuration_history")
}
