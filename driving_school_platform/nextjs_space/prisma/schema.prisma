generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model User {
  id                         String          @id @default(cuid())
  email                      String          @unique
  emailVerified              DateTime?
  image                      String?
  passwordHash               String?
  role                       UserRole        @default(STUDENT)
  firstName                  String
  lastName                   String
  phoneNumber                String?
  dateOfBirth                DateTime?
  address                    String?
  city                       String?
  postalCode                 String?
  profilePictureUrl          String?
  organizationId             String?
  isEmailVerified            Boolean         @default(false)
  emailVerificationToken     String?
  emailVerificationExpiresAt DateTime?
  isApproved                 Boolean         @default(false)
  passwordResetToken         String?
  passwordResetExpiresAt     DateTime?
  createdAt                  DateTime        @default(now())
  updatedAt                  DateTime        @updatedAt
  lastLoginAt                DateTime?
  accounts                   Account[]
  auditLogs                  AuditLog[]
  instructor                 Instructor?
  lessonRequestsReviewed     LessonRequest[] @relation("ReviewedBy")
  lessonsCancelled           Lesson[]        @relation("CancelledBy")
  notifications              Notification[]
  paymentsUser               Payment[]       @relation("PaymentUser")
  sessions                   Session[]
  student                    Student?
  preferences                UserPreference?
  organization               Organization?   @relation(fields: [organizationId], references: [id])

  @@index([email])
  @@index([role])
  @@index([isApproved])
  @@index([createdAt])
  @@index([organizationId])
  @@map("users")
}

model TransmissionType {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  code        String       @unique
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  categories  Category[]
  lessons     Lesson[]
  students    Student[]
  vehicles    Vehicle[]
  instructors Instructor[] @relation("InstructorTransmissionTypes")

  @@map("transmission_types")
}

model Category {
  id                    Int               @id @default(autoincrement())
  name                  String            @unique
  fullName              String
  description           String?
  transmissionTypeId    Int?
  minAge                Int?
  requiresTheoryExam    Boolean           @default(true)
  requiresPracticalExam Boolean           @default(true)
  minLessonHours        Int               @default(0)
  isActive              Boolean           @default(true)
  displayOrder          Int               @default(0)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  transmissionType      TransmissionType? @relation(fields: [transmissionTypeId], references: [id])
  exams                 Exam[]
  lessonCounters        LessonCounter[]
  lessonRequests        LessonRequest[]
  lessons               Lesson[]
  students              Student[]
  vehicles              Vehicle[]
  instructors           Instructor[]      @relation("InstructorCategories")

  @@map("categories")
}

model Student {
  id                           String             @id @default(cuid())
  userId                       String             @unique
  studentIdNumber              String?            @unique
  categoryId                   Int?
  transmissionTypeId           Int?
  organizationId               String?
  hasDrivingLicense            Boolean            @default(false)
  existingLicenseNumber        String?
  existingLicenseCategories    String[]
  medicalCertificateUrl        String?
  medicalCertificateExpiry     DateTime?
  emergencyContactName         String?
  emergencyContactPhone        String?
  emergencyContactRelationship String?
  preferredInstructorId        String?
  preferredLessonTime          String?
  theoryExamPassed             Boolean            @default(false)
  practicalExamPassed          Boolean            @default(false)
  enrollmentDate               DateTime           @default(now())
  graduationDate               DateTime?
  adminNotes                   String?
  specialRequirements          String?
  createdAt                    DateTime           @default(now())
  updatedAt                    DateTime           @updatedAt
  examRegistrations            ExamRegistration[]
  lessonCounters               LessonCounter[]
  lessonRequests               LessonRequest[]
  lessons                      Lesson[]
  paymentsStudent              Payment[]          @relation("PaymentStudent")
  category                     Category?          @relation(fields: [categoryId], references: [id])
  organization                 Organization?      @relation(fields: [organizationId], references: [id])
  preferredInstructor          Instructor?        @relation("PreferredStudents", fields: [preferredInstructorId], references: [id])
  transmissionType             TransmissionType?  @relation(fields: [transmissionTypeId], references: [id])
  user                         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([categoryId])
  @@index([transmissionTypeId])
  @@index([organizationId])
  @@map("students")
}

model Instructor {
  id                         String             @id @default(cuid())
  userId                     String             @unique
  instructorIdNumber         String?            @unique
  organizationId             String?
  instructorLicenseNumber    String             @unique
  instructorLicenseExpiry    DateTime
  instructorCertificateUrl   String?
  hireDate                   DateTime?
  employmentType             EmploymentType?
  hourlyRate                 Decimal?
  defaultWorkingHours        Json?
  maxLessonsPerDay           Int                @default(8)
  totalLessonsCompleted      Int                @default(0)
  averageRating              Decimal            @default(0.00)
  totalStudentsTrained       Int                @default(0)
  passRatePercentage         Decimal            @default(0.00)
  isAvailableForBooking      Boolean            @default(true)
  adminNotes                 String?
  specializations            String?
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
  exams                      Exam[]
  organization               Organization?      @relation(fields: [organizationId], references: [id])
  user                       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonRequests             LessonRequest[]
  lessons                    Lesson[]
  preferredStudents          Student[]          @relation("PreferredStudents")
  qualifiedCategories        Category[]         @relation("InstructorCategories")
  qualifiedTransmissionTypes TransmissionType[] @relation("InstructorTransmissionTypes")

  @@index([userId])
  @@index([isAvailableForBooking])
  @@index([organizationId])
  @@map("instructors")
}

model Vehicle {
  id                    Int              @id @default(autoincrement())
  registrationNumber    String           @unique
  make                  String
  model                 String
  year                  Int
  color                 String?
  vin                   String?          @unique
  categoryId            Int?
  transmissionTypeId    Int
  status                VehicleStatus    @default(AVAILABLE)
  isActive              Boolean          @default(true)
  underMaintenance      Boolean          @default(false)
  lastServiceDate       DateTime?
  nextServiceDate       DateTime?
  lastServiceMileage    Int?
  currentMileage        Int              @default(0)
  serviceIntervalKm     Int              @default(10000)
  insurancePolicyNumber String?
  insuranceExpiryDate   DateTime?
  insuranceCompany      String?
  hasDualControls       Boolean          @default(true)
  hasDashcam            Boolean          @default(false)
  fuelType              FuelType?
  vehicleImageUrl       String?
  adminNotes            String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  exams                 Exam[]
  lessonRequests        LessonRequest[]
  lessons               Lesson[]
  category              Category?        @relation(fields: [categoryId], references: [id])
  transmissionType      TransmissionType @relation(fields: [transmissionTypeId], references: [id])

  @@index([status])
  @@index([categoryId])
  @@index([transmissionTypeId])
  @@index([isActive])
  @@index([nextServiceDate])
  @@map("vehicles")
}

model LessonRequest {
  id                 String        @id @default(cuid())
  studentId          String
  instructorId       String?
  requestedDate      DateTime
  requestedStartTime String
  requestedEndTime   String
  lessonType         LessonType
  categoryId         Int
  preferredVehicleId Int?
  status             RequestStatus @default(PENDING)
  reviewedBy         String?
  reviewedAt         DateTime?
  rejectionReason    String?
  studentNotes       String?
  adminNotes         String?
  lessonId           String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  category           Category      @relation(fields: [categoryId], references: [id])
  instructor         Instructor?   @relation(fields: [instructorId], references: [id])
  lesson             Lesson?       @relation(fields: [lessonId], references: [id])
  preferredVehicle   Vehicle?      @relation(fields: [preferredVehicleId], references: [id])
  reviewer           User?         @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  student            Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([instructorId])
  @@index([status])
  @@index([requestedDate])
  @@map("lesson_requests")
}

model Lesson {
  id                       String            @id @default(cuid())
  studentId                String?
  instructorId             String
  vehicleId                Int?
  lessonDate               DateTime
  startTime                String
  endTime                  String
  durationMinutes          Int
  lessonType               LessonType
  categoryId               Int
  transmissionTypeId       Int?
  status                   LessonStatus      @default(SCHEDULED)
  startedAt                DateTime?
  completedAt              DateTime?
  startMileage             Int?
  endMileage               Int?
  pickupLocation           String?
  dropoffLocation          String?
  routeDescription         String?
  instructorRating         Int?
  instructorFeedback       String?
  skillsPracticed          String[]
  areasForImprovement      String?
  studentPerformanceRating Int?
  studentRating            Int?
  studentFeedback          String?
  cancelledBy              String?
  cancelledAt              DateTime?
  cancellationReason       String?
  lessonPrice              Decimal?
  paymentStatus            PaymentStatus     @default(PENDING)
  adminNotes               String?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  lessonRequests           LessonRequest[]
  cancelledByUser          User?             @relation("CancelledBy", fields: [cancelledBy], references: [id])
  category                 Category          @relation(fields: [categoryId], references: [id])
  instructor               Instructor        @relation(fields: [instructorId], references: [id])
  student                  Student?          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  transmissionType         TransmissionType? @relation(fields: [transmissionTypeId], references: [id])
  vehicle                  Vehicle?          @relation(fields: [vehicleId], references: [id])
  payments                 Payment[]

  @@index([studentId])
  @@index([instructorId])
  @@index([vehicleId])
  @@index([lessonDate])
  @@index([status])
  @@index([lessonType])
  @@index([lessonDate, status])
  @@index([instructorId, lessonDate])
  @@index([studentId, lessonDate])
  @@index([lessonType, lessonDate, status])
  @@map("lessons")
}

model LessonCounter {
  id                      String   @id @default(cuid())
  studentId               String
  categoryId              Int
  totalDrivingLessons     Int      @default(0)
  completedDrivingLessons Int      @default(0)
  totalTheoryLessons      Int      @default(0)
  completedTheoryLessons  Int      @default(0)
  totalDrivingHours       Decimal  @default(0.00)
  requiredDrivingHours    Decimal  @default(0.00)
  theoryExamAttempts      Int      @default(0)
  practicalExamAttempts   Int      @default(0)
  progressPercentage      Decimal  @default(0.00)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  category                Category @relation(fields: [categoryId], references: [id])
  student                 Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, categoryId])
  @@map("lesson_counters")
}

model Exam {
  id                   String             @id @default(cuid())
  examType             ExamType
  categoryId           Int
  examDate             DateTime
  startTime            String
  endTime              String
  examLocation         String
  examCenterName       String?
  vehicleId            Int?
  examinerId           String?
  maxStudents          Int                @default(1)
  currentStudentsCount Int                @default(0)
  status               ExamStatus         @default(SCHEDULED)
  specialInstructions  String?
  adminNotes           String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  registrations        ExamRegistration[]
  category             Category           @relation(fields: [categoryId], references: [id])
  examiner             Instructor?        @relation(fields: [examinerId], references: [id])
  vehicle              Vehicle?           @relation(fields: [vehicleId], references: [id])

  @@index([examDate])
  @@index([status])
  @@index([categoryId])
  @@index([examinerId])
  @@map("exams")
}

model ExamRegistration {
  id                   String           @id @default(cuid())
  examId               String
  studentId            String
  registrationDate     DateTime         @default(now())
  registrationFee      Decimal?
  paymentStatus        PaymentStatus    @default(PENDING)
  attendanceStatus     AttendanceStatus @default(REGISTERED)
  result               ExamResult?
  score                Decimal?
  examinerComments     String?
  resultDate           DateTime?
  attemptNumber        Int              @default(1)
  certificateIssued    Boolean          @default(false)
  certificateNumber    String?
  certificateIssueDate DateTime?
  certificateUrl       String?
  updatedAt            DateTime         @updatedAt
  exam                 Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  student              Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments             Payment[]

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@index([result])
  @@map("exam_registrations")
}

model Payment {
  id                 String            @id @default(cuid())
  userId             String
  studentId          String?
  amount             Decimal
  currency           String            @default("USD")
  paymentMethod      PaymentMethod?
  paymentType        PaymentType
  lessonId           String?
  examRegistrationId String?
  status             PaymentStatus     @default(PENDING)
  transactionId      String?           @unique
  transactionDate    DateTime          @default(now())
  paymentGateway     String?
  gatewayResponse    Json?
  refundAmount       Decimal?
  refundDate         DateTime?
  refundReason       String?
  receiptNumber      String?           @unique
  receiptUrl         String?
  description        String?
  adminNotes         String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  examRegistration   ExamRegistration? @relation(fields: [examRegistrationId], references: [id])
  lesson             Lesson?           @relation(fields: [lessonId], references: [id])
  student            Student?          @relation("PaymentStudent", fields: [studentId], references: [id])
  user               User              @relation("PaymentUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([studentId])
  @@index([status])
  @@index([transactionDate])
  @@index([lessonId])
  @@map("payments")
}

model Notification {
  id              String               @id @default(cuid())
  userId          String
  type            NotificationType
  title           String
  message         String
  lessonId        String?
  examId          String?
  lessonRequestId String?
  isRead          Boolean              @default(false)
  readAt          DateTime?
  sendEmail       Boolean              @default(false)
  emailSent       Boolean              @default(false)
  emailSentAt     DateTime?
  sendPush        Boolean              @default(false)
  pushSent        Boolean              @default(false)
  pushSentAt      DateTime?
  priority        NotificationPriority @default(NORMAL)
  actionUrl       String?
  createdAt       DateTime             @default(now())
  expiresAt       DateTime?
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@map("notifications")
}

model AuditLog {
  id            String      @id @default(cuid())
  userId        String?
  userEmail     String?
  userRole      UserRole?
  action        String
  entityType    String
  entityId      String?
  oldValues     Json?
  newValues     Json?
  ipAddress     String?
  userAgent     String?
  requestMethod String?
  requestPath   String?
  status        AuditStatus
  errorMessage  String?
  createdAt     DateTime    @default(now())
  user          User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

model Organization {
  id                 String                @id @default(cuid())
  name               String                @unique
  email              String?
  phoneNumber        String?
  address            String?
  city               String?
  postalCode         String?
  logo               String?
  primaryColor       String?               @default("#2563eb")
  secondaryColor     String?               @default("#dc2626")
  subscriptionTier   SubscriptionTier      @default(BASE)
  subscriptionStatus SubscriptionStatus    @default(ACTIVE)
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  contactName        String?
  billingEmail       String?
  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  instructors        Instructor[]
  licenseKeys        LicenseKey[]
  features           OrganizationFeature[]
  students           Student[]
  users              User[]

  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([isActive])
  @@map("organizations")
}

model OrganizationFeature {
  id             String       @id @default(cuid())
  organizationId String
  featureKey     String
  isEnabled      Boolean      @default(false)
  enabledAt      DateTime?
  disabledAt     DateTime?
  enabledBy      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@index([featureKey])
  @@index([isEnabled])
  @@map("organization_features")
}

model LicenseKey {
  id             String       @id @default(cuid())
  organizationId String
  key            String       @unique
  featureKeys    String[]
  isActive       Boolean      @default(true)
  isUsed         Boolean      @default(false)
  usedAt         DateTime?
  expiresAt      DateTime?
  notes          String?
  createdBy      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([key])
  @@index([isActive])
  @@map("license_keys")
}

model SystemSetting {
  id           String      @id @default(cuid())
  settingKey   String      @unique
  settingValue String
  settingType  SettingType @default(STRING)
  description  String?
  category     String?
  isPublic     Boolean     @default(false)
  updatedBy    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([category])
  @@index([isPublic])
  @@map("system_settings")
}

model FeatureFlag {
  id              String    @id @default(cuid())
  flagKey         String    @unique
  flagName        String
  description     String?
  isEnabled       Boolean   @default(false)
  enabledForRoles String[]
  enabledForUsers String[]
  rolloutPercent  Int       @default(0)
  environment     String    @default("production")
  category        String?
  tags            String[]
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  expiresAt       DateTime?

  @@index([flagKey])
  @@index([isEnabled])
  @@index([environment])
  @@map("feature_flags")
}

model UserPreference {
  id                          String   @id @default(cuid())
  userId                      String   @unique
  theme                       String   @default("light")
  language                    String   @default("en")
  emailNotifications          Boolean  @default(true)
  pushNotifications           Boolean  @default(true)
  smsNotifications            Boolean  @default(false)
  lessonReminders             Boolean  @default(true)
  examReminders               Boolean  @default(true)
  paymentReminders            Boolean  @default(true)
  promotionalEmails           Boolean  @default(false)
  weeklyDigest                Boolean  @default(true)
  defaultDashboardView        String   @default("overview")
  showCompletedLessons        Boolean  @default(true)
  lessonDisplayCount          Int      @default(5)
  calendarView                String   @default("month")
  startOfWeek                 String   @default("monday")
  timeFormat                  String   @default("24h")
  profileVisibility           String   @default("school")
  showProgressToInstructors   Boolean  @default(true)
  allowContactFromInstructors Boolean  @default(true)
  fontSize                    String   @default("medium")
  highContrast                Boolean  @default(false)
  reducedMotion               Boolean  @default(false)
  customSettings              Json?
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  user                        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model ConfigurationHistory {
  id            String   @id @default(cuid())
  entityType    String
  entityId      String
  entityKey     String?
  action        String
  oldValue      Json?
  newValue      Json?
  changedBy     String?
  changedByRole String?
  changedAt     DateTime @default(now())
  changeReason  String?
  ipAddress     String?

  @@index([entityType])
  @@index([entityId])
  @@index([changedAt])
  @@index([changedBy])
  @@map("configuration_history")
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  SUPER_ADMIN
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  OUT_OF_SERVICE
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LessonType {
  DRIVING
  THEORY
  EXAM
}

enum LessonStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  WAIVED
}

enum ExamType {
  THEORY
  PRACTICAL
}

enum ExamStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  REGISTERED
  PRESENT
  ABSENT
  CANCELLED
}

enum ExamResult {
  PASS
  FAIL
  PENDING
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  ONLINE
  MOBILE_PAYMENT
}

enum PaymentType {
  LESSON_FEE
  EXAM_FEE
  REGISTRATION_FEE
  MATERIAL_FEE
  LATE_FEE
  OTHER
}

enum NotificationType {
  LESSON_SCHEDULED
  LESSON_CANCELLED
  LESSON_REMINDER
  EXAM_SCHEDULED
  EXAM_RESULT
  PAYMENT_RECEIVED
  APPROVAL_REQUIRED
  APPROVAL_GRANTED
  APPROVAL_REJECTED
  SYSTEM_ANNOUNCEMENT
  INSTRUCTOR_ASSIGNED
  OTHER
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AuditStatus {
  SUCCESS
  FAILURE
  ERROR
}

enum SubscriptionTier {
  BASE
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  EXPIRED
  SUSPENDED
  CANCELLED
}

enum SettingType {
  STRING
  INTEGER
  BOOLEAN
  JSON
  DECIMAL
}
